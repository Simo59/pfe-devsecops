name: DevSecOps CI

on:
  push:
    branches: [ "main", "master" ]
  pull_request:

jobs:
  security-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies (no scripts)
        working-directory: node-app
        run: npm ci --ignore-scripts

      - name: Semgrep - npm install hooks
        uses: returntocorp/semgrep-action@v1
        with:
          config: security-rules/npm-scripts.yml
          paths: |
            node-app/package.json
            local-packages/evil-lib/package.json

      - name: Semgrep - suspicious commands in hooks (blocking)
        uses: returntocorp/semgrep-action@v1
        with:
          config: security-rules/npm-suspicious-commands.yml
          paths: |
            local-packages/evil-lib/package.json

      - name: npm audit (blocking high/critical)
        working-directory: node-app
        run: npm audit --audit-level=high

  build-and-scan-image:
    runs-on: ubuntu-latest
    needs: security-checks
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t pfe-node-app:ci -f node-app/Dockerfile node-app

      - name: Trivy scan image (block critical)
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: "pfe-node-app:ci"
          format: "table"
          exit-code: "1"
          severity: "CRITICAL,HIGH"
